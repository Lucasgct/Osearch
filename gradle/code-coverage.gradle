/*
 * SPDX-License-Identifier: Apache-2.0
 *
 * The OpenSearch Contributors require contributions made to
 * this file be licensed under the Apache-2.0 license or a
 * compatible open source license.
 */

apply plugin: 'java'
apply plugin: 'jacoco'

repositories {
  mavenCentral()
}

jacoco {
    toolVersion = "0.8.7"
}

task generateMergedReport(type: JacocoReport) {
    //dependsOn = subprojects.test
  //dependsOn(':server:test')
//    subprojects.each {
//      if (it.tasks.findByName('test'))
//        dependsOn("${it.name}:test") }
//  SourceSet[] allMainSourceSets = ([sourceSets.main] + subprojects*.sourceSets.main) as SourceSet[]
//  sourceSets allMainSourceSets
  doLast {
//    subprojects.each {
//      if(it.tasks.findByPath('test') && it.tasks.findByPath('test').enabled == true) {
//        print it.sourceSets.main.allSource.srcDirs
//      }
//    }
    subprojects.each {
      if(it.tasks.findByPath('test') && it.tasks.findByPath('test').enabled == true && it.sourceSets.findByName("main")) {
        //println it.sourceSets.main.output
        //println project('server').sourceSets.main.output.classesDirs
      }
    }
  }

  def excludeFilter = ['distribution/bwc/minor/build']
  classDirectories.setFrom fileTree(dir: '.', include: '**/build/classes/java/main/**/*.class', exclude: excludeFilter)
  executionData.setFrom fileTree(dir: '.', include: '**/build/jacoco/test.exec')

//    additionalSourceDirs.setFrom files(subprojects.sourceSets.main.allSource.srcDirs)
//    sourceDirectories.setFrom files(subprojects.sourceSets.main.allSource.srcDirs)
//    classDirectories.setFrom files(subprojects.sourceSets.main.output)
//    executionData.setFrom project.fileTree(dir: '.', include: '**/build/jacoco/test.exec')
    reports {
      xml.enabled true
      csv.enabled false
      html.enabled true
    }
}

task jacocoGenerateRootReport(type: JacocoReport, group: 'Test Reporting') {
  description = 'Generates aggregate report from all subprojects.'

  def includeFilter = ['**/build/classes/java/**/*.class']
  def excludeFilter = ['**/classes']
  // classes which have duplicated names to overcome ` Can't add different class with same name issue` See https://github.com/jacoco/jacoco/issues/858
  def classTree = fileTree(dir: "${rootProject.projectDir}", includes: includeFilter, excludes: excludeFilter)
  def sourceTree = fileTree(dir: "${rootProject.projectDir}", includes: ['**/src/main/java/**/*.*'])
  def executionTree = fileTree(dir: "${rootProject.projectDir}", includes: ['**/build/jacoco/*.exec'])

  classDirectories.from = files([classTree])
  sourceDirectories.from = files([sourceTree])
  executionData.from = files([executionTree])

  reports {
    xml.enabled true
    html.enabled true
    xml.destination file("${rootProject.projectDir}/build/reports/jacoco/report.xml")
  }
}
