---
"Test unmap the object type fields beyond the total fields limit":
  - skip:
      version: " - 2.99.99"
      reason: "introduced in 3.0.0"
  - do:
      indices.create:
        index: test_index_1
        body:
          settings:
            index.mapping.total_fields.limit: 3
            index.mapping.total_fields.unmap_fields_beyond_limit: true

  - do:
      index:
        index:   test_index_1
        id: 1
        body:    {
          field1: "field1",
          field2: [1,2,3],
          unmapField: "foo"
        }
  - do:
      get:
        index: test_index_1
        id: 1
  - match: { _source:  {  field1: "field1", field2: [1,2,3], unmapField: "foo" }}

  - do:
      indices.get_mapping:
        index: test_index_1
  - match: {test_index_1.mappings.properties.field1.type:     text}
  - match: {test_index_1.mappings.properties.field1.fields.keyword.type:     keyword}
  - match: {test_index_1.mappings.properties.field2.type:     long}
  - match: {test_index_1.mappings.properties.unmapField: null}

  - do:
      index:
        index:   test_index_1
        id: 2
        body:    {
          field3: {
            "field4": "field4"
          },
          "field5": 100
        }
  - do:
      get:
        index: test_index_1
        id: 2
  - match: { _source:  {  field3: { field4: "field4" }, field5: 100 }}

  - do:
      indices.get_mapping:
        index: test_index_1
  - match: {test_index_1.mappings.properties.field1.type:     text}
  - match: {test_index_1.mappings.properties.field1.fields.keyword.type:     keyword}
  - match: {test_index_1.mappings.properties.field2.type:     long}
  - match: {test_index_1.mappings.properties.field3: null}
  - match: {test_index_1.mappings.properties.field5: null}

  - do:
      indices.put_settings:
        index: test_index_1
        body:
          index.mapping.total_fields.limit: 100

  - do:
      indices.get_settings:
        index: test_index_1
  - match: {test_index_1.settings.index.mapping.total_fields.limit:     "100"}

  - do:
      index:
        index:   test_index_1
        id: 2
        body:    {
          field1: "field1",
          field2: [1,2,3],
          field3: {
            "field4": "field4"
          },
          "field5": 100
        }
  - do:
      get:
        index: test_index_1
        id: 2
  - match: { _source:  {  field1: "field1", field2: [1,2,3], field3: { field4: "field4" }, field5: 100 }}

  - do:
      indices.get_mapping:
        index: test_index_1
  - match: {test_index_1.mappings.properties.field1.type:     text}
  - match: {test_index_1.mappings.properties.field1.fields.keyword.type:     keyword}
  - match: {test_index_1.mappings.properties.field2.type:     long}
  - match: {test_index_1.mappings.properties.field3.properties.field4.type:     text}
  - match: {test_index_1.mappings.properties.field3.properties.field4.fields.keyword.type:     keyword}
  - match: {test_index_1.mappings.properties.field5.type:     long}
