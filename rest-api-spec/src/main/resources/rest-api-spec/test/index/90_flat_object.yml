---
# Create flat_object mapping
setup:
  - do:
      indices.create:
        index: test
        body:
          mappings:
            properties:
              ISBN13:
                type : "keyword"
              catalog:
                type : "flat_object"
              required_matches:
                type : "long"

# Delete Index when connection is teardown
---
teardown:
  - do:
      indices.delete:
        index: test

# Upload a sample document to index
---
"Flat object test":
  - skip:
      version: " - 2.99.99"
      reason: "flat_object is introduced in 3.0.0 in main branch"
  - do:
      index:
        index: test
        id:    1
        body:  {
          "ISBN13": "V9781933988177",
          "catalog": {
            "title": "Lucene in Action",
            "author":
              {
                "surname": "McCandless",
                "given": "Mike"
              },
            "catalogId":"c-0002"
          },
          "required_matches": 1
        }
  - do:
      index:
        index: test
        id: 2
        body: {
          "ISBN13": "V12154942129175",
          "catalog": {
            "title": "Mock in Action",
            "author":
              {
                "surname": "Doe",
                "given": "John"
              },
            "catalogId": "c-0050"
          },
          "required_matches": 1
        }

  # Do index refresh
  - do:
      indices.refresh:
        index: test

  # Verify that mapping under the catalog field did not expand.
  # Verify that there are no dynamic fields created.
  # https://github.com/opensearch-project/OpenSearch/tree/main/rest-api-spec/src/main/resources/rest-api-spec/test#length
  - do:
      indices.get_mapping:
        index: test
  - is_true: test.mappings
  - match: { test.mappings.properties.ISBN13.type:  keyword     }
  - match: { test.mappings.properties.catalog.type: flat_object }
  - match: { test.mappings.properties.required_matches.type: long }
  - length: { test.mappings.properties: 3 }
  - length: { test.mappings.properties.catalog: 1 }

  # Verify Document Count
  - do:
      search:
        body: {
          query: {
            match_all: {}
          }
        }

  - length:   { hits.hits: 2  }

  # Match Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            match: { "catalog.title": "Lucene in Action"}
          }
        }

  - length:   { hits.hits: 1  }
  - match: { hits.hits.0._source.catalog.title: "Lucene in Action" }

  # Match Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            match: { catalog: "Lucene in Action"}
          }
        }

  - length:   { hits.hits: 1  }
  - match: { hits.hits.0._source.catalog.title: "Lucene in Action" }


  # Multi Match Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            multi_match: {
              "query":    "Mike",
              "fields": [ "ISBN13", "catalog" ]
            }
          }
        }

  - length:   { hits.hits: 1  }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Multi Match Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            multi_match: {
              "query": "Mike",
              "fields": [ "ISBN13", "catalog.author.given" ]
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Term Query1 with dot path
  - do:
      search:
        body: {
          _source: true,
          query: {
            term: { catalog.title: "Lucene in Action"}
          }
        }

  - length:   { hits.hits: 1  }
  - match: { hits.hits.0._source.catalog.title: "Lucene in Action" }

  # Term Query2 with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            term: { "catalog.author.given": "Mike" }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Term Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            term: { catalog: "Mike" }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Terms Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            terms: { catalog: ["John","Mike"] }
          }
        }

  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Terms Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            terms: { catalog.author.given: ["John","Mike"] }
          }
        }

  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Termset Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "terms_set": {
              "catalog": {
                "terms": [  "John","Mike" ],
                "minimum_should_match_field": "required_matches"}
            }
          }
        }
  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Termset Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "terms_set": {
              "catalog.author.given": {
                "terms": [  "John","Mike" ],
                "minimum_should_match_field": "required_matches"}
            }
          }
        }
  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Prefix Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "prefix": {
              "catalog.author.given": {
                "value": "Mi"
              }
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Prefix Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "prefix": {
              "catalog": {
                "value": "Mi"
              }
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Range Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "range": {
              "catalog.catalogId": {
                "gte": "c-0000",
                "lte": "c-0006"
              }
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.catalogId: "c-0002" }

  # Range Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "range": {
              "catalog": {
                "gte": "c-0000",
                "lte": "c-0006"
              }
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.catalogId: "c-0002" }

  # Exists Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "exists": {
              "field": catalog.catalogId
            }
          }
        }

  - length: { hits.hits: 2 }

  # Exists Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "exists": {
              "field": catalog
            }
          }
        }

  - length: { hits.hits: 2 }

  # Query_string Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "query_string": {
              "fields": [ "catalog", "ISBN13" ],
              "query": "John OR Mike"
            }
          }
        }

  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Query_string Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "query_string": {
              "fields": [ "catalog.author.given", "ISBN13" ],
              "query": "John OR Mike"
            }
          }
        }

  - length: { hits.hits: 2 }
  - match: { hits.hits.0._source.catalog.author.given: "Mike" }

  # Simple_query_string Query without dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "simple_query_string" : {
              "query": "Doe",
              "fields": ["catalog", "ISBN13"]
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.surname: "Doe" }


  # Simple_query_string Query with dot path.
  - do:
      search:
        body: {
          _source: true,
          query: {
            "simple_query_string": {
              "query": "Doe",
              "fields": [ "catalog.author.surname", "ISBN13" ]
            }
          }
        }

  - length: { hits.hits: 1 }
  - match: { hits.hits.0._source.catalog.author.surname: "Doe" }
