---
teardown:
  - do:
      ingest.delete_pipeline:
        id: "1"
        ignore: 404

---
"Test set processor with template value":
  - do:
      ingest.put_pipeline:
        id: "1"
        body:  >
          {
            "processors": [
              {
                "set" : {
                  "field" : "foo",
                  "value" : "{{bar}}",
                  "ignore_empty_value" : true
                }
              }
            ]
          }
  - match: { acknowledged: true }

  - do:
      index:
        index: test
        id: 1
        pipeline: "1"
        body: {
          foo: "hello"
        }
  - do:
      index:
        index: test
        id: 2
        pipeline: "1"
        body: {
          foo: "hello",
          bar: ""
        }

  - do:
      get:
        index: test
        id: 1
  - match: { _source.foo: "hello" }

  - do:
      get:
        index: test
        id: 2
  - match: { _source.foo: "hello" }
---
"Test set processor with index change and require_alias":
  - do:
      ingest.put_pipeline:
        id: "1"
        body:  >
          {
            "processors": [
              {
                "set" : {
                  "field" : "_index",
                  "value" : "new_require_alias_index"
                }
              }
            ]
          }
  - match: { acknowledged: true }
  - do:
      catch: missing
      index:
        index:   test_require_alias
        pipeline: 1
        require_alias: true
        body:    { foo: bar }

  - do:
      catch: missing
      indices.get:
        index: test_require_alias
  - do:
      catch: missing
      indices.get:
        index: new_require_alias_index

  - do:
      indices.create:
        index: backing_index
        body:
          mappings: {}
          aliases:
            new_require_alias_index: {}

  - do:
      index:
        index:   test_require_alias
        pipeline: 1
        require_alias: true
        body:    { foo: bar }

---
"Test modifying op_type by set processor":
  - skip:
      version: " - 2.99.99"
      reason: "introduced in 3.0.0"

  - do:
      ingest.put_pipeline:
        id: "pipeline1"
        body:  >
          {
            "description": "_description",
            "processors": [
              {
                "set" : {
                  "field" : "_op_type",
                  "value": "create"
                }
              }
            ]
          }

  - do:
      ingest.put_pipeline:
        id: "pipeline2"
        body:  >
          {
            "description": "_description",
            "processors": [
              {
                "set" : {
                  "field" : "_op_type",
                  "value": "invalidOpType"
                }
              }
            ]
          }

  - do:
      indices.put_index_template:
        name: test_index_template_for_data_stream
        body:
          index_patterns: test_data_stream1*
          data_stream: {}
          template:
            settings:
              number_of_shards:   1
              number_of_replicas: 0
  - do:
      indices.create_data_stream:
        name: test_data_stream1

  - do:
      index:
        index:    test_data_stream1
        id:       1
        op_type:  index
        pipeline: pipeline1
        body:   { "foo": "bar", "@timestamp": "2099-03-08T11:04:05.000Z" }
  - match: { result: "created" }

  - do:
      catch: /illegal_argument_exception/
      index:
        index:    test_data_stream1
        id:       1
        op_type:  index
        pipeline: pipeline2
        body:   { "foo": "bar", "@timestamp": "2099-03-08T11:04:05.000Z" }

  - do:
      ingest.delete_pipeline:
        id: "pipeline1"
        ignore: 404
  - do:
      ingest.delete_pipeline:
        id: "pipeline2"
        ignore: 404
  - do:
      indices.delete_data_stream:
        name: test_data_stream1
        ignore: 404
  - do:
      indices.delete_index_template:
        name: test_index_template_for_data_stream
        ignore: 404
